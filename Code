// --- ตั้งค่าชื่อชีท ---
var SHEET_INVOICE = "อินวอย";      
var SHEET_RECEIPT = "ใบเสร็จ";     
var SHEET_DATA    = "ฐานข้อมูล";    
var SHEET_PRODUCTS = "Products"; 
var TIMEZONE      = "Asia/Bangkok"; 

function doGet(e) {
  return HtmlService.createTemplateFromFile('Index')
      .evaluate()
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL) 
      .setTitle('ระบบออกใบแจ้งหนี้ - Sea World');
}

function getInitialData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var todayStr = Utilities.formatDate(new Date(), TIMEZONE, "yyyy-MM-dd");
  
  try {
    var nextInv = invoiceNextNumber(ss); 
    
    var dbSheet = ss.getSheetByName(SHEET_DATA);
    var customers = [];
    
    // Optimizing data read: Read only necessary columns if possible, but keep it robust
    if (dbSheet && dbSheet.getLastRow() > 1) {
      // อ่านเฉพาะคอลัมน์ลูกค้า (C) เพื่อความเร็ว
      var lastRow = dbSheet.getLastRow();
      var data = dbSheet.getRange(2, 3, lastRow - 1, 1).getValues();
      var unique = {};
      for (var i = 0; i < data.length; i++) {
        if (data[i][0]) unique[data[i][0]] = true;
      }
      customers = Object.keys(unique);
    }
    
    var prodSheet = ss.getSheetByName(SHEET_PRODUCTS);
    var products = [];
    if (prodSheet && prodSheet.getLastRow() > 1) { 
      var pData = prodSheet.getDataRange().getValues();
      for(var i=1; i<pData.length; i++){
        if(pData[i][0]) products.push({ name: pData[i][0], price: pData[i][1] });
      }
    }

    // Load dashboard data for today
    var dashboardData = getDashboardData(todayStr);

    return { 
      status: "success",
      invNo: nextInv, 
      date: todayStr,
      customers: customers,
      products: products,
      dashboard: dashboardData
    };
  } catch (e) {
    return { status: "error", message: e.toString() };
  }
}

function getDashboardData(dateStr) { 
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_DATA);
  if (!sheet || sheet.getLastRow() < 2) return [];

  // Optimization: ดึงข้อมูลทั้งหมดมาครั้งเดียวแล้ววนลูปใน Memory เร็วกว่าเรียก Sheet หลายรอบ
  var data = sheet.getDataRange().getValues();
  var result = [];

  // Loop ย้อนกลับ (จากล่าสุดไปเก่า) เพื่อประสิทธิภาพในการหาข้อมูลล่าสุด
  for (var i = data.length - 1; i >= 1; i--) {
    var dateCell = data[i][1]; 
    
    if (dateCell instanceof Date) {
      var rowDate = Utilities.formatDate(dateCell, TIMEZONE, "yyyy-MM-dd");
      
      if (rowDate === dateStr) {
        var itemsStr = data[i][4] ? data[i][4].toString().toLowerCase() : "";
        var isJetski = itemsStr.indexOf("jetski") > -1 || 
                       itemsStr.indexOf("เจ็ทสกี") > -1 || 
                       itemsStr.indexOf("seadoo") > -1 || 
                       itemsStr.indexOf("yamaha") > -1;

        result.push({
          invNo: data[i][0],      
          customer: data[i][2],   
          total: data[i][7],      
          status: data[i][8],
          isJetski: isJetski
        });
      }
    }
  }
  // เนื่องจากเราวนย้อนกลับ ข้อมูลจะเรียงจากใหม่ไปเก่าอยู่แล้ว ไม่ต้อง reverse ซ้ำ หรือถ้าต้องการเก่าไปใหม่ค่อย reverse
  return result; 
}

function getReportData(month, year) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_DATA);
  if (!sheet || sheet.getLastRow() < 2) return { status: 'empty' };

  var data = sheet.getDataRange().getValues();
  
  var totalRevenue = 0;
  var jetskiCount = 0;
  var jetskiRevenue = 0;
  var ppCount = 0;
  var ppRevenue = 0;
  
  var dailyMap = {};

  for (var i = 1; i < data.length; i++) {
    var dateCell = data[i][1]; 
    var status = data[i][8]; 

    if (dateCell instanceof Date && status !== 'แคนเซิล') {
      var dateString = Utilities.formatDate(dateCell, TIMEZONE, "yyyy-MM-dd");
      var parts = dateString.split("-"); 
      var pYear = parseInt(parts[0]);
      var pMonth = parseInt(parts[1]);
      var pDay = parseInt(parts[2]); 

      if (pMonth == month && pYear == year) {
        var rowTotal = Number(data[i][7] || 0);
        totalRevenue += rowTotal;

        if (!dailyMap[pDay]) {
          dailyMap[pDay] = { 
            day: pDay, 
            dateStr: dateString,
            total: 0, 
            jetski: {count:0, amount:0}, 
            pp: {count:0, amount:0} 
          };
        }
        dailyMap[pDay].total += rowTotal;

        var itemsStr = data[i][4] ? data[i][4].toString() : "";
        if (itemsStr.indexOf("::") > -1) {
          var rawItems = itemsStr.split("||");
          rawItems.forEach(function(item) {
            var parts = item.split("::"); 
            if (parts.length >= 3) {
              var name = parts[0].toLowerCase();
              var qty = Number(parts[1] || 0);
              var price = Number(parts[2] || 0);
              var amount = qty * price;

              if (name.indexOf("jetski") > -1 || name.indexOf("เจ็ทสกี") > -1 || name.indexOf("seadoo") > -1) {
                jetskiCount += qty;
                jetskiRevenue += amount;
                dailyMap[pDay].jetski.count += qty;
                dailyMap[pDay].jetski.amount += amount;
              }
              else if (name.indexOf("pp") > -1 || name.indexOf("พีพี") > -1 || name.indexOf("phi phi") > -1) {
                ppCount += qty;
                ppRevenue += amount;
                dailyMap[pDay].pp.count += qty;
                dailyMap[pDay].pp.amount += amount;
              }
            }
          });
        }
      }
    }
  }

  var dailyArray = [];
  for (var key in dailyMap) {
    dailyArray.push(dailyMap[key]);
  }
  dailyArray.sort(function(a, b) { return a.day - b.day; });

  return {
    status: 'success',
    month: month,
    year: year,
    summary: {
      total: totalRevenue,
      jetski: { count: jetskiCount, amount: jetskiRevenue },
      pp: { count: ppCount, amount: ppRevenue }
    },
    daily: dailyArray
  };
}

function updateStatus(invNo, newStatus) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(SHEET_DATA);
  var data = sheet.getDataRange().getValues();
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] == invNo) {
      sheet.getRange(i + 1, 9).setValue(newStatus); 
      SpreadsheetApp.flush(); 
      return { status: 'success', message: 'Status Updated' };
    }
  }
  return { status: 'error', message: 'Invoice Not Found' };
}

function searchInvoice(invNo) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetData = ss.getSheetByName(SHEET_DATA);
  
  if (!sheetData) return { status: 'error', message: 'ไม่พบฐานข้อมูล' };
  
  var data = sheetData.getDataRange().getValues();
  var foundData = null;
  
  // Optimization: Loop backwards might be faster if searching recent invoices
  for (var i = data.length - 1; i >= 1; i--) {
    if (data[i][0] == invNo) {
      foundData = data[i];
      break;
    }
  }
  
  if (!foundData) return { status: 'error', message: 'ไม่พบเลขบิล: ' + invNo };

  var items = [];
  if (foundData[4] && foundData[4].toString().indexOf("::") > -1) {
    var rawItems = foundData[4].toString().split("||");
    rawItems.forEach(function(itemStr) {
      var parts = itemStr.split("::");
      if (parts.length >= 3) {
        items.push({ desc: parts[0], qty: parts[1], price: parts[2] });
      }
    });
  }

  return {
    status: 'success',
    invNo: foundData[0],
    date: Utilities.formatDate(new Date(foundData[1]), TIMEZONE, "yyyy-MM-dd"),
    customer: foundData[2],
    address: foundData[3],
    notes: foundData[11], 
    items: items
  };
}

// ========================================================
// ฟังก์ชันสร้าง PDF (Optimized for Speed)
// ========================================================
function processInvoice(form, docType) {
  var lock = LockService.getScriptLock();
  try {
    // ลดเวลารอ Lock ลงเผื่อมีคิวค้าง
    lock.waitLock(5000); 
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheetData = ss.getSheetByName(SHEET_DATA);
    
    var targetSheetName = (docType === 'receipt') ? SHEET_RECEIPT : SHEET_INVOICE;
    var printSheet = ss.getSheetByName(targetSheetName);
    
    if (!printSheet) throw new Error("ไม่พบชีท: " + targetSheetName);

    // [1] เคลียร์ข้อมูลเก่า
    printSheet.getRange('B9:B15').clearContent(); 
    printSheet.getRange('A18:E35').clearContent(); 
    printSheet.getRange('E36:E38').clearContent(); 

    // [2] เขียน Header
    printSheet.getRange('B9').setValue(form.invNo);
    var dateParts = form.date.split("-");
    var dateObj = new Date(dateParts[0], dateParts[1]-1, dateParts[2]);
    dateObj.setHours(12, 0, 0, 0); 
    
    printSheet.getRange('B10').setValue(dateObj);   
    printSheet.getRange('B12').setValue(form.customer); 
    printSheet.getRange('B13').setValue(form.address);  
    
    if (docType === 'receipt') {
        printSheet.getRange('B15').setValue(form.invNo);
    }

    // [3] เขียนรายการสินค้า
    var itemsArr = form.items; 
    var saveStringItems = []; 
    var subTotal = 0;
    var maxRows = 18; 

    // ใช้ Array ในการเตรียมข้อมูลก่อนเขียนลง Sheet ครั้งเดียว เพื่อลดการเรียก API (ถ้าทำได้)
    // แต่เพื่อความเสถียรของฟอร์แมตเดิม จะคงลูปไว้แต่ทำให้กระชับ
    for (var i = 0; i < itemsArr.length; i++) {
      if (i >= maxRows) break; 
      
      var item = itemsArr[i];
      var row = 18 + i; 
      
      printSheet.getRange('A' + row).setValue(i + 1);
      printSheet.getRange('B' + row).setValue(item.desc);
      printSheet.getRange('C' + row).setValue(item.qty);
      printSheet.getRange('D' + row).setValue(item.price);
      printSheet.getRange('E' + row).setFormula('=C'+row+'*D'+row);
      
      saveStringItems.push(item.desc + "::" + item.qty + "::" + item.price);
      subTotal += (item.qty * item.price);
    }
    
    // จัด Format
    printSheet.getRange('C18:C35').setHorizontalAlignment("center");
    printSheet.getRange('D18:E35').setHorizontalAlignment("right");

    // [4] เขียนยอดรวม
    printSheet.getRange('E36').setValue(subTotal); 
    printSheet.getRange('E37').setValue(0); // VAT 0       
    printSheet.getRange('E38').setValue(subTotal); 
    
    // บังคับให้ Sheet คำนวณสูตรทันที
    SpreadsheetApp.flush();

    // [5] บันทึกลงฐานข้อมูล
    var vat = 0; 
    var total = subTotal + vat;
    var itemStr = saveStringItems.join("||");
    var status = (docType === 'receipt') ? "จ่ายแล้ว" : "ส่งบิลแล้ว";

    var rowData = [
      form.invNo, dateObj, form.customer, form.address, 
      itemStr, subTotal, vat, total, 
      status, 
      "", "", form.notes, 
      Session.getActiveUser().getEmail(), new Date()
    ];

    var data = sheetData.getDataRange().getValues();
    var foundRowIndex = -1;
    // Check backwards for faster update on recent items
    for (var i = data.length - 1; i >= 1; i--) {
      if (data[i][0] == form.invNo) {
        foundRowIndex = i + 1;
        break;
      }
    }

    if (foundRowIndex > 0) {
      sheetData.getRange(foundRowIndex, 1, 1, rowData.length).setValues([rowData]);
    } else {
      sheetData.appendRow(rowData);
    }

    SpreadsheetApp.flush(); 
    
    // === KEY IMPROVEMENT: ลดเวลา Sleep ===
    // เดิม 4000 (4 วินาที) นานเกินไป ลดเหลือ 800ms ก็เพียงพอให้สูตรคำนวณเสร็จ
    Utilities.sleep(800); 

    var prefix = (docType === 'receipt') ? "Receipt_" : "Invoice_";
    var pdfUrl = createPdf(ss, printSheet, prefix + form.invNo);
    
    return { status: 'success', url: pdfUrl, type: docType };

  } catch (e) {
    return { status: 'error', message: e.toString() };
  } finally {
    lock.releaseLock();
  }
}

function createPdf(ss, sheet, fileName) {
  var url = "https://docs.google.com/spreadsheets/d/" + ss.getId() + "/export?" +
            "exportFormat=pdf&format=pdf" +
            "&size=A4&portrait=true" +
            "&fitw=true" +  
            "&sheetnames=false&printtitle=false&pagenumbers=false&gridlines=false" +
            "&fzr=false&gid=" + sheet.getSheetId() + 
            "&range=A1:E52"; 

  var token = ScriptApp.getOAuthToken();
  var response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
  var blob = response.getBlob().setName(fileName);
  
  var files = DriveApp.getFilesByName(fileName);
  while (files.hasNext()) files.next().setTrashed(true); 

  var file = DriveApp.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  
  return "https://drive.google.com/file/d/" + file.getId() + "/view";
}

function invoiceNextNumber(ss){
  if(!ss) ss = SpreadsheetApp.getActiveSpreadsheet();
  var dt = new Date();
  var prefix = Utilities.formatDate(dt, TIMEZONE, 'yyyyMM') + '-';
  var dataSheet = ss.getSheetByName(SHEET_DATA);
  
  if(!dataSheet || dataSheet.getLastRow() < 2) return prefix + '010';
  
  // Optimization: อ่านเฉพาะคอลัมน์ A (Invoice Number)
  var lastRow = dataSheet.getLastRow();
  var data = dataSheet.getRange(2, 1, lastRow-1, 1).getValues();
  
  var maxNum = 0;
  // Loop ย้อนกลับ 50 แถวก็พอ เพราะเลขล่าสุดน่าจะอยู่ล่างสุด เพื่อความเร็ว
  // แต่เพื่อความชัวร์ (เผื่อมีการแก้เลขย้อนหลัง) จะ Loop ทั้งหมดแบบเร็วๆ
  for(var i=0; i<data.length; i++){
    var str = data[i][0].toString();
    if(str.indexOf(prefix) === 0) {
      var num = parseInt(str.replace(prefix, ''));
      if(!isNaN(num) && num > maxNum) maxNum = num;
    }
  }
  return maxNum < 9 ? prefix + '010' : prefix + Utilities.formatString('%03d', maxNum + 1);
}
